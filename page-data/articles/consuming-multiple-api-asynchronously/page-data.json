{"componentChunkName":"component---src-templates-post-js","path":"/articles/consuming-multiple-api-asynchronously/","result":{"data":{"site":{"siteMetadata":{"title":"Jabran Rafique - Software Engineer (Web)","author":"Jabran Rafique"}},"markdownRemark":{"id":"ac0ea2ad-d651-52cd-9a73-2d540cd1ba99","excerpt":"Recently, I worked on few Facebook apps that utilized multiple Application Programming Interfaces(APIs) in addition to default Facebook Graph API. Applications…","html":"<p>Recently, I worked on few Facebook apps that utilized multiple Application Programming Interfaces(APIs) in addition to default <a href=\"https://developers.facebook.com/docs/graph-api/\">Facebook Graph API</a>. Applications normally use provided Software Development Kits(SDKs) to consume an API. At front-end development, majority of developers, prefer to use JavaScript SDKs for such a purpose. Consuming multiple APIs can be tricky in single app sometime—especially when using their JavaScript SDKs.</p>\n<p>There can be multiple reasons behind this tricky behaviour but an obvious one is not able to calculate the load time of an SDK. It can vary from app to app and even from page to page. Therefore, loading multiple SDKs and parallel consumption of their associated APIs, can lead to unexpected responses. For Facebook Graph API, most common examples are <a href=\"http://stackoverflow.com/search?q=fb.getloginstatus+called+before+fb.init\">early call warnings for FB methods</a>.</p>\n<blockquote>\n<p>In an ideal world of APIs, their JavaScript SDKs will be loaded asynchronously – for almost 99.9% of the time – to make sure the priority loading of the app and a valid response is returned for any calls made to API.</p>\n</blockquote>\n<p><a href=\"http://j.mp/1ohip3T\">USA Outdoors Adventure</a> app recognises its users by using Facebook Graph API and then loads their up-to-date status by consuming Graph, Google Maps and its own Outdoors Adventure(OA) API. The process flow is as following:</p>\n<ul>\n<li>Check user status (Graph API)</li>\n<li>Confirm user registration (OA API)</li>\n<li>Check user status and get user data (OA API)</li>\n<li>Load user status (Google Maps API)</li>\n</ul>\n<p>To stick with this cascading flow, API calls need to be chained accordingly to avoid errors, unexpected results or early call warnings. So APIs call flow goes as following:</p>\n<ul>\n<li>Call Graph API</li>\n<li>Call OA API as a callback to Graph API</li>\n<li>Call Google Maps API as a callback to OA API</li>\n<li>Setup front-end using final data in hand</li>\n</ul>\n<p>Here I will go through all these steps explaining how it works best by chaining calls for multiple APIs. <sup>1</sup></p>\n<h2>Facebook Graph API</h2>\n<p>This app uses Facebook user ID in order to identify and keep track of user progress. Facebook JavaScript SDK has built-in methods of returning asynchronous calls that can defer custom steps until SDKs are fully loaded so the relevant functions are available to the app. Here is quick overview with default Facebook SDK initialization code:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\">window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">fbAsyncInit</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token constant\">FB</span><span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n\t\tappId   <span class=\"token punctuation\">:</span> <span class=\"token string\">'1234567890'</span><span class=\"token punctuation\">,</span>\n\t\txfbml   <span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n\t\tversion <span class=\"token punctuation\">:</span> <span class=\"token string\">'v2.0'</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">// Callback function goes here</span>\n\t<span class=\"token constant\">FB</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLoginStatus</span><span class=\"token punctuation\">(</span>myCallbackFunc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> js<span class=\"token punctuation\">,</span> fjs <span class=\"token operator\">=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">}</span>\n\tjs <span class=\"token operator\">=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> js<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> id<span class=\"token punctuation\">;</span>\n\tjs<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token string\">\"//connect.facebook.net/en_US/sdk.js\"</span><span class=\"token punctuation\">;</span>\n\tfjs<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>js<span class=\"token punctuation\">,</span> fjs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">,</span> <span class=\"token string\">'script'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'facebook-jssdk'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Passing a custom function <code class=\"language-text\">myCallbackFunc</code> in <code class=\"language-text\">FB.getLoginStatus(...)</code>, will have a deferred execution and will be served as callback.</p>\n<p>Now depending on personal choice, that may or may not be an optimal workflow – so here is a better workflow by using <a href=\"http://jabran.me/projects/socialmedia-js\">Socialmedia.js</a>. Making an exact similar call with <code class=\"language-text\">Socialmedia.js</code> could not be anymore simpler.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> myFbApp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Socialmedia<span class=\"token punctuation\">.</span>Facebook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  appid<span class=\"token punctuation\">:</span> <span class=\"token string\">'12345678'</span><span class=\"token punctuation\">,</span>\n  callback<span class=\"token punctuation\">:</span> myCallbackFunc\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>Outdoors Adventure (OA) API</h2>\n<p>Now that we have Facebook SDK ready to use as well as user status from Graph API. We can use user status to determine if user is connected to the app as yet so we can make use of OA API or ask user to connect otherwise.</p>\n<p>A simple <code class=\"language-text\">jQuery.getJSON</code> call grabs user data from OA API. But first, we want user to authenticate the app by giving appropriate permissions so that we know who this user is. Here is the breakdown of complete scenario:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">myCallbackFunc</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token function\">isConnectedUser</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token constant\">FB</span><span class=\"token punctuation\">.</span><span class=\"token function\">api</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/me'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">info</span><span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span>\n\n\t\t\t<span class=\"token keyword\">return</span>\n\t\t\t\t$<span class=\"token punctuation\">.</span><span class=\"token function\">getJSON</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user?uid=info.id&amp;token=secretToken'</span><span class=\"token punctuation\">)</span>\n\n\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">done</span><span class=\"token punctuation\">(</span>loadGoogleMapsFunc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">fail</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">jqxhr<span class=\"token punctuation\">,</span> textStatus<span class=\"token punctuation\">,</span> error</span><span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token comment\">// handle errors here</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token constant\">FB</span><span class=\"token punctuation\">.</span><span class=\"token function\">login</span><span class=\"token punctuation\">(</span>myCallbackFunc<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> scope<span class=\"token punctuation\">:</span> <span class=\"token string\">'email'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">isConnectedUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>response <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>status <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'connected'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>Google Maps API</h2>\n<p>Now that we have the user identity, status and progress data in JSON format, we can utilize this information for a personalised Google Maps layout. Here is the breakdown to load Google Maps functions.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">loadGoogleMapsFunc</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">json</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> map <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\tmapOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t\tcenter<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">google<span class=\"token punctuation\">.</span>maps<span class=\"token punctuation\">.</span>LatLng</span><span class=\"token punctuation\">(</span><span class=\"token number\">35.589439</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">106.387605</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\tzoom<span class=\"token punctuation\">:</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span>\n\t\tdisableDefaultUI<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n\tmap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">google<span class=\"token punctuation\">.</span>maps<span class=\"token punctuation\">.</span>Map</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mapCanvas'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> mapOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">/**\n\t * Using built-in event listener of Google Maps API, we can\n\t * defer loading the data on map until map is fully loaded,\n\t */</span>\n\n\tgoogle<span class=\"token punctuation\">.</span>maps<span class=\"token punctuation\">.</span>event<span class=\"token punctuation\">.</span><span class=\"token function\">addListenerOnce</span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">,</span> <span class=\"token string\">'tiles_loaded'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">setupLocationData</span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Google Maps is loaded now and ready to use. It is time to load user data to display on map. Here we go:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">setupLocationData</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">map<span class=\"token punctuation\">,</span> json</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">var</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> json<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">var</span> info <span class=\"token operator\">=</span> json<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">var</span> marker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">google<span class=\"token punctuation\">.</span>maps<span class=\"token punctuation\">.</span>Marker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n\t\t\tposition<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">google<span class=\"token punctuation\">.</span>maps<span class=\"token punctuation\">.</span>LatLng</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>lat<span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">.</span>lng<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\tid<span class=\"token punctuation\">:</span> info<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n\t\t\tinfo<span class=\"token punctuation\">:</span> info<span class=\"token punctuation\">,</span>\n\t\t\tmap<span class=\"token punctuation\">:</span> map\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This process may go on as we add more and more interactivity into this. We can also display a loading status or animated progress cricle between calls so to provide a better user experience and so on.</p>\n<p>So go ahead and try<sup>2</sup> the <a href=\"http://j.mp/1oVh3SD\">USA Outdoors Adventure app</a>. Your feedback or any questions are always welcome!</p>\n<footer>\n<ol>\n<li><a href=\"http://requirejs.org\">Require.js</a> can also be used to manage chained calls between multiple libraries.</li>\n<li>Eligibility to enter into competition is explained in app terms.</li>\n</ol>\n</footer>","timeToRead":4,"frontmatter":{"title":"Consuming multiple APIs asynchronously","code":null,"date":"August 21, 2014"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/articles/consuming-multiple-api-asynchronously/","previous":{"fields":{"slug":"/articles/twitter-uk-developers-meetup/"},"frontmatter":{"title":"First ever Twitter UK Developers meetup","permalink":null}},"next":{"fields":{"slug":"/articles/making-public-data-more-readable--accessible/"},"frontmatter":{"title":"Making public data more readable and accessible","permalink":null}}}}}