
  



  

<!doctype html>
<html lang="en" xmlns:fb="http://ogp.me/ns/fb#">
  <head>
    <meta charset="UTF-8" />
    <title>Performance audits with GatsbyJS and Lighthouse - Jabran Rafique</title>
    <meta name="description" content="Full Stack Web Engineer, currently Front-End Tech Lead at Rated People" />
    <meta name="keywords" content="blog, jabran, rafique, html, css, javascript, react, php, full stack, front-end" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Performance audits with GatsbyJS and Lighthouse - Jabran Rafique" />
    <meta property="og:description" content="Full Stack Web Engineer, currently Front-End Tech Lead at Rated People" />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@jabranr">
    <meta name="twitter:creator" content="@jabranr">
    <meta name="twitter:title" content="Performance audits with GatsbyJS and Lighthouse - Jabran Rafique">
    <meta name="twitter:description" content="Full Stack Web Engineer, currently Front-End Tech Lead at Rated People">
    <meta property="og:image" content="https://jabran.me/assets/images/icon-1024x1024.png" />
    <meta name="twitter:image" content="https://jabran.me/assets/images/icon-1024x1024.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="msapplication-TileImage" content="https://jabran.me/assets/images/apple-touch-icon-114x114.png" />
    <meta name="theme-color" content="#f55555" />
    
      <meta property="robots" content="all" />
      <meta property="og:url" content="https://jabran.me/articles/performance-audits-with-lighthouse-and-gatsbyjs/">
      <link rel="canonical" href="https://jabran.me/articles/performance-audits-with-lighthouse-and-gatsbyjs/" />
    
    <link rel="preconnect" href="https://www.googletagmanager.com" />
    <link rel="preconnect" href="https://www.google-analytics.com" />
    <link rel="manifest" href="https://jabran.me/manifest.json?v=1641552143587" />
    <link rel="icon" type="image/x-icon" href="https://jabran.me/assets/images/favicon.ico" />
    <link rel="apple-touch-icon" href="https://jabran.me/assets/images/apple-touch-icon-114x114.png" />

    <link href="https://jabran.me/assets/css/normalize.css?v=1641552143587" rel="stylesheet" />
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet"></noscript>
    <link href="https://jabran.me/assets/css/styles.css?v=1641552143587" rel="stylesheet" />


    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MHKHDT');</script>
    <!-- End Google Tag Manager -->
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MHKHDT"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <div class="wrapper">
      <header class="header container-fluid">
        <section class="container header_inner">
          
            <a class="h1 logo" href="/">Jabran Rafique</a>
          
        </section>
      </header>
      <main class="main">



<section class="container breadcrumbs">
  <a href="/">Home</a> &rsaquo; <a href="/articles/">Articles</a>
</section>

<section class="container-fluid">
  <section class="container post">
    <h1 class="article_header underlined">Performance audits with GatsbyJS and Lighthouse</h1>
    <time datetime="2019-02-05" class="article_time">
      February 05, 2019 &bull; 3 minutes read
    </time>
    <section class="article_content">
      <div class="ads">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4297681002419123" crossorigin="anonymous"></script>
        <!-- Banner ad -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4297681002419123"
             data-ad-slot="6682049184"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>
      <p>GatsbyJS is a great tool to create static pages. The best part is the integration of different modern technologies together e.g. NodeJS, ReactJS and GraphQL. A combination of those in GatsbyJS gives you set of powerful tools and commands that sets out a world of unlimited opportunities.</p>
<p>I came across this requirement of integrating performance audits on a GatsbyJS project as part of the Continuous Development(CD) and Continuous Integration(CI) pipelines. <a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a> is without a doubt the best tool out there for such purpose.</p>
<p>Audits are meant to be performed on a production build to reflect more accurate results. Therefore in order to run an audit we must have a production build and being served from a server. GatsbyJS provides options to create a production build and serve it from a local server. These commands are <code>gatsby build</code> and <code>gatsby serve</code> respectively.</p>
<p>Normally I would have these as a combined command inside <code>npm scripts</code> in <code>package.json</code> i.e.</p>
<pre class="language-json"><code class="language-json">...<br><br><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  <span class="token property">"develop"</span><span class="token operator">:</span> <span class="token string">"gatsby develop"</span><span class="token punctuation">,</span><br>  <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"gatsby build"</span><span class="token punctuation">,</span><br>  <span class="token property">"preview"</span><span class="token operator">:</span> <span class="token string">"gatsby build &amp;&amp; gatsby serve"</span><br><span class="token punctuation">}</span><br><br>...</code></pre>
<p>Now we can run <code>npm run preview</code> in terminal and it will serve the production site at <code>http://localhost:9000</code>. Now we can perform an audit using Chrome browser DevTools <code>Audit</code> tab which will produce a nice report for us.</p>
<blockquote>
<p>There is an excellent guide on this at <a href="https://www.gatsbyjs.org/docs/audit-with-lighthouse/">GatsbyJS docs</a>.</p>
</blockquote>
<p>However, in order to have this run in a CD/CI pipeline, we need command-line interface of <code>lighthouse</code> that we can install as a node module.</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -D lighthouse</code></pre>
<p>or</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> -D lighthouse</code></pre>
<p>Then we can modify our <code>npm scripts</code> in <code>package.json</code> to include following:</p>
<pre class="language-json"><code class="language-json">...<br><br><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  ...<br><br>  <span class="token property">"preview:start"</span><span class="token operator">:</span> <span class="token string">"(gatsby build &amp;&amp; (gatsby serve &amp;))"</span><span class="token punctuation">,</span><br>  <span class="token property">"preview:stop"</span><span class="token operator">:</span> <span class="token string">"lsof -i tcp:9000 | awk '{print $2}' | grep \"[0-9]\" | xargs kill -9"</span><span class="token punctuation">,</span><br>  <span class="token property">"audit"</span><span class="token operator">:</span> <span class="token string">"lighthouse http://localhost:9000"</span><span class="token punctuation">,</span><br><br>  <span class="token property">"perf:audit"</span><span class="token operator">:</span> <span class="token string">"npm run preview:start ; (npm run audit -- --view &amp;&amp; npm run preview:stop)"</span><br><span class="token punctuation">}</span><br><br>...</code></pre>
<p>It may already be self-explanatory but here is quick run through:</p>
<ul>
<li><code>audit</code> runs the <code>lighthouse</code> on given URL which in this case is <code>http://localhost:9000</code> since GatsbyJS serves the site on port 9000.</li>
<li><code>preview:start</code> is same as <code>preview</code> command but with some difference. It makes sure that GatsbyJS serves the site in background and does not block further commands to run.</li>
<li><code>preview:stop</code> basically kills the GatsbyJS service running in the background assuming it is running on port 9000</li>
<li><code>perf:audit</code> runs the combination of above commands to make a build, serve it in the background, run the <code>lighthouse</code> audit, opens the report in browser and kills the background service</li>
</ul>
<blockquote>
<p>The <code>--view</code> flag to <code>lighthouse</code> part will open the report in browser after it is ready.</p>
</blockquote>
<h2>Gotcha</h2>
<p>GatsbyJS will try to serve on port 9000 but if some other process is already using it then it may offer another port to serve. Normally an increment by one e.g. 9001. In such a case, <code>lighthouse</code> may fail to run as port 9000 may not be the one serving the GatsbyJS site.</p>
<h2>Usage in CI pipeline</h2>
<p>Since <code>lighthouse</code> can generate report in different formats including JSON, it can easily be read and evaluated by CI tools. This would be useful for a website with set performance budget so that in a CI pipeline, a build will fail if it does not meet the defined minimum criteria. This is what we are trying to achieve at <a href="https://www.ratedpeople.com">Rated People</a>.</p>
<h3>References</h3>
<ul>
<li><a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse documentation</a></li>
<li><a href="https://www.gatsbyjs.com">GatsbyJS documentation</a></li>
</ul>

    </section>

    
      <section class="more-pagination">
        <h3 class="more-pagination_heading">More articles</h3>
        <section class="more-pagination_content">
          <a rel="prev" class="more-pagination_prev" href="/articles/building-information-platform/"><span class="more-pagination_guide">&laquo;</span> Building an information platform</a>
          <a rel="next" class="more-pagination_next" href="/README/"> <span class="more-pagination_guide">&raquo;</span></a>
        </section>
      </section>
    
  </section>
</section>
</main>
      <footer class="footer container-fluid">
        <div class="container footer_inner">
          <div>
            <p>&copy; 2012 &ndash; present</p>
            <div class="colophone bullets">
              <a target="_blank" rel="noopener noreferrer" href="https://www.twitter.com/jabranr">Twitter</a>
              <a target="_blank" rel="noopener noreferrer" href="https://github.com/jabranr">GitHub</a>
              <a target="_blank" rel="noopener noreferrer" href="https://google.com/mapmaker?gw=66&amp;uid=208599960765438642668">Google Map Maker</a>
              <a href="mailto:hello@jabran.me">Contact</a>
              <a href="/sitemap.xml">RSS</a>
            </div>
            <p><span class="heart">&hearts;</span> I like to develop on ideas that are useful and beneficial to everyone. All contents and code samples are licensed under the MIT License unless stated otherwise.</p>
            <hr />
            <p>This website uses cookies to deliver better user experience. By continuing to use this website you agree to the use of cookies.</p>
          </div>
          
        </div>
      </footer>
    </div>
    
  </body>
</html>
