
  



  

<!doctype html>
<html lang="en" xmlns:fb="http://ogp.me/ns/fb#">
  <head>
    <meta charset="UTF-8" />
    <title>Automatic database backup using Git (Bitbucket/GitLab/Github) - Jabran Rafique</title>
    <meta name="description" content="Full Stack Web Engineer, currently Front-End Tech Lead at Rated People" />
    <meta name="keywords" content="blog, jabran, rafique, html, css, javascript, react, php, full stack, front-end" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Automatic database backup using Git (Bitbucket/GitLab/Github) - Jabran Rafique" />
    <meta property="og:description" content="Full Stack Web Engineer, currently Front-End Tech Lead at Rated People" />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@jabranr">
    <meta name="twitter:creator" content="@jabranr">
    <meta name="twitter:title" content="Automatic database backup using Git (Bitbucket/GitLab/Github) - Jabran Rafique">
    <meta name="twitter:description" content="Full Stack Web Engineer, currently Front-End Tech Lead at Rated People">
    <meta property="og:image" content="https://jabran.me/assets/images/icon-1024x1024.png" />
    <meta name="twitter:image" content="https://jabran.me/assets/images/icon-1024x1024.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="msapplication-TileImage" content="https://jabran.me/assets/images/apple-touch-icon-114x114.png" />
    <meta name="theme-color" content="#f55555" />
    
      <meta property="robots" content="all" />
      <meta property="og:url" content="https://jabran.me/articles/automatic-database-backup-using-git-hosting/">
      <link rel="canonical" href="https://jabran.me/articles/automatic-database-backup-using-git-hosting/" />
    
    <link rel="preconnect" href="https://www.googletagmanager.com" />
    <link rel="preconnect" href="https://www.google-analytics.com" />
    <link rel="manifest" href="https://jabran.me/manifest.json?v=1641554102835" />
    <link rel="icon" type="image/x-icon" href="https://jabran.me/assets/images/favicon.ico" />
    <link rel="apple-touch-icon" href="https://jabran.me/assets/images/apple-touch-icon-114x114.png" />

    <link href="https://jabran.me/assets/css/normalize.css?v=1641554102835" rel="stylesheet" />
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet"></noscript>
    <link href="https://jabran.me/assets/css/styles.css?v=1641554102835" rel="stylesheet" />


    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MHKHDT');</script>
    <!-- End Google Tag Manager -->
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MHKHDT"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <div class="wrapper">
      <header class="header container-fluid">
        <section class="container header_inner">
          
            <a class="h1 logo" href="/">Jabran Rafique</a>
          
        </section>
      </header>
      <main class="main">



<section class="container breadcrumbs">
  <a href="/">Home</a> &rsaquo; <a href="/articles/">Articles</a>
</section>

<section class="container-fluid">
  <section class="container post">
    <h1 class="article_header underlined">Automatic database backup using Git (Bitbucket/GitLab/Github)</h1>
    <time datetime="2016-04-25" class="article_time">
      April 25, 2016 &bull; 5 minutes read
    </time>
    <section class="article_content">
      <div class="ads">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4297681002419123" crossorigin="anonymous"></script>
        <!-- Banner ad -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4297681002419123"
             data-ad-slot="6682049184"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>
      <blockquote>
<p>This walk-through is based on Ubuntu 12LTS+ to backup MySQL databases. It may be usable to backup other type of databases with additional to no tweaks. Use this as guidelines only and always try on a dummy database before setting it up on a production database. Of course by all means trying it is completely at your own risk.</p>
</blockquote>
<p>If your work involves a database or collection of databases there are high chances that you need to create backups on regular basis to make sure you do not loose any valuable data. Setting up an automatic backup task is probably the most easiest way of making sure that everything is in order. One of the ways is to setup a cron job for such a task that would run at specific intervals.</p>
<p>Another concern in this automated task is to where to store such valuable data and most easy way to restore it when required. Using a private Git respository on one of the services (<a href="https://bitbucket.org">Bitbucket</a> / <a href="https://gitlab.com">GitLab</a> / <a href="https://github.com">Github</a>) is a cheap, secure and efficient way.</p>
<h2>Setup a cron user</h2>
<p>Let's start with creating a special MySQL user called <code>cron_user</code> but you can name it anything you like. Login into MySQL by replacing USER with your username:</p>
<pre class="language-bash"><code class="language-bash">$ mysql -u <span class="token environment constant">USER</span> -p</code></pre>
<p>Create a new user with password (always use a strong password and make sure to save it to safe place before moving forward):</p>
<pre class="language-bash"><code class="language-bash">$ CREATE <span class="token environment constant">USER</span> <span class="token string">'cron_user'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'someStrongPassword'</span><span class="token punctuation">;</span></code></pre>
<p>Now grant only specific privileges to this user and flush privileges to bring all changes in effect:</p>
<pre class="language-bash"><code class="language-bash">$ GRANT SELECT,LOCK TABLES, EVENT, TRIGGER, SHOW VIEW PRIVILEGES ON *.* TO <span class="token string">'cron_user'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span><br>$ FLUSH PRIVILEGES<span class="token punctuation">;</span></code></pre>
<p>Our <code>cron_user</code> is ready for use now.</p>
<h2>Setup local and remote repository</h2>
<p>Now create a fresh empty repository now on any of above mentioned services and name is <code>database-backups</code>. Now <code>ssh</code> to your server using any Terminal app and make a backup directory at <code>/home/backup</code> and <code>cd</code> into it.</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">mkdir</span> -p /home/backup/database-backups <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> /home/backup/database-backups</code></pre>
<p>Create a shell script file and make it executable.</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">touch</span> cron_backup.sh<br>$ <span class="token function">chmod</span> +x cron_backup.sh</code></pre>
<p>Add Git and add remote repository.</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">git</span> init<br>$ <span class="token function">git</span> remote <span class="token function">add</span> origin <span class="token punctuation">{</span>path/to/remote/database-backups.git<span class="token punctuation">}</span><br>$ <span class="token function">git</span> <span class="token function">add</span> -A<br>$ <span class="token function">git</span> commit -am <span class="token string">'Add files'</span><br>$ <span class="token function">git</span> push -u origin HEAD</code></pre>
<h2>Setup cron script</h2>
<p>Use any of your favourite editor to edit the file. Here I am using <code>nano</code>.</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">nano</span> cron_backup.sh</code></pre>
<p>Add following script, save and exit of editor (CTRL x).</p>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span><br><span class="token comment"># Set variables</span><br><span class="token assign-left variable">DB_NAME</span><span class="token operator">=</span><span class="token string">"foo"</span><br><span class="token assign-left variable">CRON_USER</span><span class="token operator">=</span><span class="token string">"bar"</span><br><br><span class="token assign-left variable">FULLDATE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%Y-%d-%m %H:%M"</span><span class="token variable">)</span></span><br><span class="token assign-left variable">NOW</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%Y-%m-%d-%H-%M"</span><span class="token variable">)</span></span><br><span class="token assign-left variable">MYSQL_DUMP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">which</span> mysqldump<span class="token variable">`</span></span><br><span class="token assign-left variable">GIT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">which</span> <span class="token function">git</span><span class="token variable">`</span></span><br><span class="token assign-left variable">TEMP_BACKUP</span><span class="token operator">=</span><span class="token string">"latest_backup.sql"</span><br><span class="token assign-left variable">BACKUP_DIR</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%Y/%m"</span><span class="token variable">)</span></span><br><br><span class="token comment"># Check current Git status and update</span><br><span class="token variable">${GIT}</span> status<br><span class="token variable">${GIT}</span> pull origin HEAD<br><br><span class="token comment"># Dump database</span><br><span class="token variable">${MYSQL_DUMP}</span> -u <span class="token string">"<span class="token variable">$CRON_USER</span>"</span> <span class="token variable">$DB_NAME</span> <span class="token operator">></span> <span class="token variable">$TEMP_BACKUP</span> <span class="token operator">&amp;</span><br><span class="token function">wait</span><br><br><span class="token comment"># Make backup directory if not exists (format: {year}/{month}/)</span><br><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$BACKUP_DIR</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span><br>  <span class="token function">mkdir</span> -p <span class="token variable">$BACKUP_DIR</span><br><span class="token keyword">fi</span><br><br><span class="token comment"># Compress SQL dump</span><br><span class="token function">tar</span> -cvzf <span class="token variable">$BACKUP_DIR</span>/<span class="token variable">$DB_NAME</span>-<span class="token variable">$NOW</span>-sql.tar.gz <span class="token variable">$TEMP_BACKUP</span><br><br><span class="token comment"># Remove original SQL dump</span><br><span class="token function">rm</span> -f <span class="token variable">$TEMP_BACKUP</span><br><br><span class="token comment"># Add to Git and commit</span><br><span class="token variable">${GIT}</span> <span class="token function">add</span> -A<br><span class="token variable">${GIT}</span> commit -m <span class="token string">"Automatic backup - <span class="token variable">$FULLDATE</span>"</span><br><span class="token variable">${GIT}</span> push origin HEAD</code></pre>
<p>Let's go through what each line does in this script:</p>
<ul>
<li><code>#!/bin/sh</code> tells that this script will use shell from this path</li>
<li>Next block sets different values in variables so we can reuse those in script. Here you will only need to update <code>DB_NAME</code> for your database name and <code>CRON_USER</code> with your specially created cron user name.</li>
<li><code>${GIT} status</code> checks for current status of the repository</li>
<li><code>${GIT} pull</code> performs fetch and pull to get latest from remote</li>
<li><code>${MYSQL_DUMP} -u &quot;$CRON_USER&quot; $DB_NAME &gt; $TEMP_BACKUP &amp; wait</code> performs a MySQL dump and save it as a temporary file.</li>
<li>Next block of script checks if a directory exists and if not then creates it. To keep the backup structured we setup directories in {year}/{month}/ format.</li>
<li><code>tar -cvzf $BACKUP_DIR/$DB_NAME-$NOW-sql.tar.gz $TEMP_BACKUP</code> compresses and saves the temporary MySQL dump file with dated name. This shall save us a massive amount of space as repository grows bigger with each backup.</li>
<li><code>rm -f $TEMP_BACKUP</code> removes the original MySQL dump file as we do not want duplicates.</li>
<li>Next block literally adds the newly created backup file to version control and commit with a dated message before it pushes it back to remote.</li>
</ul>
<p>Running this short script will dump the specified database, gzip it using <code>tar</code> and then add it to a Git repository before updating to remote. But to make this script work, we need to make sure that some settings are in place.</p>
<h2>Setup <code>mysqldump</code> credentials</h2>
<p>As you may have noticed that you did not have to enter any password for MySQL <code>CRON_USER</code>. If we run this script now, it will fail and return an authentication error. We could create user with no password and avoid this error but we should not have a MySQL user interacting with database without an empty or no password – as it would a serious security risk even though this user has limited permissions. To make sure that <code>mysqldump</code> does not return an authentication error, let's create a file <code>.my.cnf</code> at user root level.</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token builtin class-name">cd</span><br>$ <span class="token function">nano</span> ~/.my.cnf</code></pre>
<p>Add following credentials to this file.</p>
<pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>mysqldump<span class="token punctuation">]</span><br><span class="token assign-left variable">user</span><span class="token operator">=</span>CRON_USER_NAME<br><span class="token assign-left variable">password</span><span class="token operator">=</span>CRON_USER_PASSWORD</code></pre>
<p>Make sure to update <code>CRON_USER_NAME</code> and <code>CRON_USER_PASSWORD</code> with correct credentials. Save and exit the editor (CTRL x). Now we have fixed the authentication issue. If we have run the script now by issuing following command, we can see our remote repository being updated with a file of fresh backup.</p>
<pre class="language-bash"><code class="language-bash">$ ./cron_backup.sh</code></pre>
<p>Reference: <a href="http://stackoverflow.com/questions/9293042/mysqldump-without-the-password-prompt">Stackoverflow</a></p>
<h2>Setup cron job</h2>
<p>Our next step is to setup a cron job so this script runs a specific time automically. Issue following command to edit the cron job file.</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">crontab</span> -u <span class="token environment constant">USER</span> -e</code></pre>
<p>Replace <code>USER</code> with correct user name who has the permissions to repository and the backup directory. This shall open the cron job file in an editor. Navigate to the end of the file and add following line.</p>
<pre class="language-bash"><code class="language-bash">@daily <span class="token builtin class-name">cd</span> /home/backup/database-backups<span class="token punctuation">;</span> /home/backup/database-backups/cron_backup.sh <span class="token operator">></span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span></code></pre>
<p>This line creates a daily cron job for midnight. It will change directory to <code>/home/backup/database-backups</code> and then run <code>cron_backup.sh</code>.</p>
<p><a href="https://gist.github.com/jabranr/d4939b2b48fdcadc74765a3ed04d8157">Here is a Gist</a> for cron script.</p>

    </section>

    
      <section class="more-pagination">
        <h3 class="more-pagination_heading">More articles</h3>
        <section class="more-pagination_content">
          <a rel="prev" class="more-pagination_prev" href="/articles/first-tech-job/"><span class="more-pagination_guide">&laquo;</span> Journey from medical education to #FirstTechJob</a>
          <a rel="next" class="more-pagination_next" href="/articles/css-pseudo-elements/">CSS pseudo elements <span class="more-pagination_guide">&raquo;</span></a>
        </section>
      </section>
    
  </section>
</section>
</main>
      <footer class="footer container-fluid">
        <div class="container footer_inner">
          <div>
            <p>&copy; 2012 &ndash; present</p>
            <div class="colophone bullets">
              <a target="_blank" rel="noopener noreferrer" href="https://www.twitter.com/jabranr">Twitter</a>
              <a target="_blank" rel="noopener noreferrer" href="https://github.com/jabranr">GitHub</a>
              <a target="_blank" rel="noopener noreferrer" href="https://google.com/mapmaker?gw=66&amp;uid=208599960765438642668">Google Map Maker</a>
              <a href="mailto:hello@jabran.me">Contact</a>
              <a href="/sitemap.xml">RSS</a>
            </div>
            <p><span class="heart">&hearts;</span> I like to develop on ideas that are useful and beneficial to everyone. All contents and code samples are licensed under the MIT License unless stated otherwise.</p>
            <hr />
            <p>This website uses cookies to deliver better user experience. By continuing to use this website you agree to the use of cookies.</p>
          </div>
          
        </div>
      </footer>
    </div>
    
  </body>
</html>
